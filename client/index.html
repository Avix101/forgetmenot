<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Forget Me Not</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="style.css">
	<script src="https://npmcdn.com/babel-core@5.8.38/browser.min.js"></script>
	<script type="text/babel">
		"use strict";
		
		let postOverlay, confirmDeleteOverlay, sendReminderOverlay, notifyOverlay; 
		let addHeader, updateHeader, postButton, updateButton;
		let eventsRef = [];
		
		const handleResponse = (xhr, metaFlag) => {
			
			if(metaFlag){
				console.log(xhr.response);
				return;
			}
			
			const events = document.querySelector("#events");
			
			events.innerHTML = "";
			
			const data = JSON.parse(xhr.response);
			eventsRef = data.events;
			
			if(data.events){
			
				for(let i = 0; i < data.events.length; i++){
					const eventTile = document.createElement('div');
					const header = document.createElement('h2');
					const date = document.createElement('p');
					const time = document.createElement('p');
					const description = document.createElement('p');
					const buttonContainer = document.createElement('p');
					const editBtn = document.createElement('button');
					const deleteBtn = document.createElement('button');
					const emailBtn = document.createElement('button');
					const textBtn = document.createElement('button');
					
					const eventData = data.events[i];
					
					header.textContent = eventData['event_title'];
					date.textContent = `Date: ${eventData['event_date'].split('T')[0]}`;
					description.textContent = `Description: ${eventData['event_description']}`;
					
					if(eventData['event_time']){
						time.textContent = `Time: ${eventData['event_time']}`;
					} else {
						time.textContent = "Time: N/A (All Day)";
					}
					
					editBtn.textContent = "Edit Event";
					editBtn.className = "btn btn-warning";
					editBtn.addEventListener('click', openUpdateOverlay);
					editBtn.setAttribute('eventindex', i);
					
					deleteBtn.textContent = "Delete Event";
					deleteBtn.className = "btn btn-danger";
					deleteBtn.addEventListener('click', openDeleteOverlay);
					deleteBtn.setAttribute('eventindex', i);
					
					emailBtn.textContent = "Email Me";
					emailBtn.className = "btn btn-success";
					emailBtn.addEventListener('click', openReminderOverlay);
					
					textBtn.textContent = "Text Me";
					textBtn.className = "btn btn-success";
					textBtn.addEventListener('click', openReminderOverlay);
					
					eventTile.classList.add("event-right-anim");
					eventTile.style.animationDelay = `${0.2 * i}s`;
					
					buttonContainer.appendChild(editBtn);
					buttonContainer.appendChild(deleteBtn);
					buttonContainer.appendChild(emailBtn);
					buttonContainer.appendChild(textBtn);
					
					eventTile.appendChild(header);
					eventTile.appendChild(date);
					eventTile.appendChild(time);
					eventTile.appendChild(description);
					eventTile.appendChild(buttonContainer);
					
					events.appendChild(eventTile);
					
					if(i < data.events.length -1) {
						events.appendChild(document.createElement('hr'));
					}
				}
			}
			console.log(xhr.response);
		};

		const getEvents = (e, form) => {
			const action = form.getAttribute("action");
			const method = form.querySelector("#methodSelect").value;
			
			const xhr = new XMLHttpRequest();
			
			xhr.open(method, action);
			xhr.setRequestHeader("Accept", "application/json");
			
			xhr.onload = () => handleResponse(xhr, method === 'head');
			
			xhr.send();
			
			e.preventDefault();
			return false;
		};

		const postEvent = (e, form) => {
			const action = form.getAttribute("action");
			const method = form.getAttribute("method");
			
			const title = form.querySelector("#titleField").value;
			const date = form.querySelector("#dateField").value;
			const time = form.querySelector("#timeField").value;
			const description = form.querySelector("#descriptionField").value;
			
			const privacySelect = form.querySelector("#privacySelect");
			const privacy = privacySelect.options[privacySelect.selectedIndex].value;
			
			const xhr = new XMLHttpRequest();
			
			xhr.open(method, action);
			xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
			xhr.setRequestHeader("Accept", "application/json");
			
			xhr.onload = () => handleResponse(xhr, false);
			
			const data = `title=${title}&date=${date}&time=${time}&description=${description}&privacy=${privacy}`;
			
			xhr.send(data);
			
			e.preventDefault();
			return false;
		};
		
		const closeAndResetOverlay = (overlay) => {
			overlay.classList.remove("overlay-down-anim");
			overlay.classList.add("overlay-up-anim");
		};
		
		const openOverlay = (overlay) => {
			closeAndResetOverlay(postOverlay);
			closeAndResetOverlay(confirmDeleteOverlay);
			closeAndResetOverlay(sendReminderOverlay);
			closeAndResetOverlay(notifyOverlay);
			
			overlay.style.display = "block";
			overlay.classList.remove("overlay-up-anim");
			overlay.classList.add("overlay-down-anim");
		};
		
		const openAddOverlay = (e) => {
			
			openOverlay(postOverlay);
			
			addHeader.style.display = "block";
			updateHeader.style.display = "none";
			postButton.style.display = "inline-block";
			updateButton.style.display = "none";
			
			const form = document.querySelector("#eventForm");
			
			form.querySelector("#titleField").value = "";
			form.querySelector("#dateField").value = "";
			form.querySelector("#timeField").value = "";
			form.querySelector("#descriptionField").value = "";
			form.querySelector("#privacySelect").selectedIndex = 0;
		};
		
		const openUpdateOverlay = (e) => {
			
			openOverlay(postOverlay);
			
			addHeader.style.display = "none";
			updateHeader.style.display = "block";
			postButton.style.display = "none";
			updateButton.style.display = "inline-block";
			
			const eventIndex = e.currentTarget.getAttribute("eventindex");
			const event = eventsRef[eventIndex];
			const form = document.querySelector("#eventForm");
			
			form.querySelector("#titleField").value = event["event_title"];
			form.querySelector("#dateField").value = event["event_date"].split('T')[0];
			form.querySelector("#timeField").value = event["event_time"];
			form.querySelector("#descriptionField").value = event["event_description"];
			form.querySelector("#privacySelect").selectedIndex = event["event_private"] ? 1 : 0;
		};
		
		const openDeleteOverlay = (e) => {
			openOverlay(confirmDeleteOverlay);
		};
		
		const openReminderOverlay = (e) => {
			openOverlay(sendReminderOverlay);
		};
		
		const openNotifyOverlay = (e) => {
			openOverlay(notifyOverlay);
		};

		const init = () => {
			const eventForm = document.querySelector("#eventForm");
			const getDataForm = document.querySelector("#getDataForm");
			const addEventButton = document.querySelector("#addEvent");
			const cancelButton = document.querySelector("#cancelPost");
			
			addHeader = document.querySelector("#addHeader");
			updateHeader = document.querySelector("#updateHeader");
			postButton = document.querySelector("#postButton");
			updateButton = document.querySelector("#updateButton");
			
			postOverlay = document.querySelector("#addEventOverlay");
			confirmDeleteOverlay = document.querySelector("#confirmDeleteOverlay");
			sendReminderOverlay = document.querySelector("#sendReminderOverlay");
			notifyOverlay = document.querySelector("#notifyOverlay");
			
			eventForm.addEventListener('submit', (e) => {
				postEvent(e, eventForm);
				closeAndResetOverlay(postOverlay);
			});
			
			getDataForm.addEventListener('submit', (e) => {
				getEvents(e, getDataForm);
			});
			
			addEventButton.addEventListener('click', (e) => {
				openAddOverlay(e);
			});
			
			cancelButton.addEventListener('click', (e) => {
				closeAndResetOverlay(postOverlay);
			});
		};

		window.onload = init;
	</script>
</head>

<body>
	<h1>Forget Me Not</h1>
	<hr />
	
	<div class="container">
		<p>We're here to help you remember the important things in life.</p>
		<button id="addEvent" class="btn">Add Event</button>
	</div>
	
	<div class="container">
		<form id="getDataForm" action="/getEvents" method="get">
			<select id="methodSelect">
				<option value="get">GET</option>
				<option value="head">HEAD</option>
			</select>
			<input type="submit" value="Get Events" />
		</form>
	</div>
		
	<div id="events" class="container"></div>
	
	<dialog id="notifyOverlay" class="overlay">
		<h2>Notification</h2>
		<hr />
		
		<p id="notificationText">No notification.</p>
		<button class="btn btn-info">Dismiss</button>
	</dialog>
	
	<dialog id="sendReminderOverlay" class="overlay">
		<form id="reminderForm" action="/sendReminder" method="post">
			<h2 id="emailheader">Email Reminder</h2>
			<h2 id="textReminder">Text Reminder</h2>
			<hr />
			
			<p id="emailPara">
				<label for="title">Email Address: </label>
				<input class="form-control center-block" id="emailField" name="email" type="email" />
			</p>
			<p id="phoneNumberPara">
				<label for="title">Phone Number: </label>
				<input class="form-control center-block" id="phoneNumberField" name="phone" type="tel" />
			</p>
			<hr />
			
			<button class="btn btn-danger">Cancel</button>
			<input id="sendEmail" type="submit" class="btn btn-success" value="Send Email" />
			<input id="sendText" type="button" class="btn btn-info" value="Send Text" />
		</form>
	</dialog>
	
	<dialog id="confirmDeleteOverlay" class="overlay">
		<h2>Delete Event</h2>
		<hr />
		
		<p id="confirmDeleteText">Are you sure you want to delete this event? This action cannot be undone.</p>
		<button class="btn btn-warning">Cancel</button>
		<button class="btn btn-danger">Delete Event</button>
	</dialog>
	
	<dialog id="addEventOverlay" class="overlay">
		<form id="eventForm" action="/postEvent" method="post">
			<h2 id="addHeader">Add Event</h2>
			<h2 id="updateHeader">Update Event</h2>
			<hr />
			
			<p>
				<label for="title">Event Title: </label>
				<input class="form-control center-block" id="titleField" name="title" type="text" />
			</p>
			<p>
				<label for="description">Event Description: </label>
				<textarea class="form-control center-block" rows="5" id="descriptionField" name="description"></textarea>
			</p>
			<p>
				<label for="date">Event Date: </label>
				<input class="form-control center-block" id="dateField" name="date" type="date" />
			</p>
			<p>
				<label for="time">Time (Optional): </label>
				<input class="form-control center-block" id="timeField" name="time" type="time" />
			</p>
			<p>
				<label for="privacy">Event Privacy: </label>
				<select id="privacySelect" class="form-control center-block" name="privacy">
					<option value="false">Public</option>
					<option value="true">Private</option>
				</select>
			</p>
			<hr />
			
			<p>
				<input id="cancelPost" type="button" class="btn btn-danger" value="Cancel" />
				<input id="postButton" type="submit" class="btn btn-success" value="Post Event" />
				<input id="updateButton" type="button" class="btn btn-info" value="Update" />
			</p>
		</form>
	</dialog>
</body>
</html>